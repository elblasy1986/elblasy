<!DOCTYPE html>
<html lang="en" class="standalone-page no-scroll">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Nickname â€“ World Clickers</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        .custom-select-wrapper {
            position: relative;
            width: 100%;
            font-family: 'Roboto', sans-serif;
            user-select: none;
            text-align: left;
        }

        .custom-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #000;
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .custom-select-trigger:hover {
            border-color: rgba(255, 255, 255, 0.4);
        }

        .custom-select-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-select-display img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }

        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #000;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: -2px;
        }

        .custom-select-options.hidden {
            display: none;
        }

        .custom-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            cursor: pointer;
            color: #fff;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .custom-option:hover,
        .custom-option.selected {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .custom-option img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }

        .custom-select-options::-webkit-scrollbar {
            width: 6px;
        }

        .custom-select-options::-webkit-scrollbar-track {
            background: #000;
        }

        .custom-select-options::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
    </style>
</head>

<body class="standalone-page no-scroll">
    <script src="api.js"></script>
    <div class="page-wrapper">
        <h1 class="guide-title">Choose Nickname</h1>

        <div class="nickname-container">
            <p class="nickname-instruction">
                Please enter your unique nickname. <br>
                <span>(3-12 characters. English/Latin letters, numbers, dots, underscores, and hyphens only.)</span>
            </p>

            <div class="input-group">
                <input type="text" id="nickname-input" placeholder="Enter nickname..." minlength="3" maxlength="12"
                    autofocus>
                <p id="error-msg" class="error-text hidden">Must be 3-12 characters.</p>
            </div>

            <div class="input-group" style="margin-top: 25px;">
                <label for="country-select"
                    style="display: block; font-family: 'Bungee', cursive; color: #ffd700; text-shadow: 2px 2px 0px #000; margin-bottom: 15px; font-size: 1.1em; letter-spacing: 0.5px;">
                    Confirm your country
                </label>

                <div class="custom-select-wrapper" id="country-select-wrapper">
                    <div class="custom-select-trigger" id="country-select-trigger">
                        <div class="custom-select-display" id="country-select-display">
                            <span style="color: rgba(255,255,255,0.6);">-- Select Country --</span>
                        </div>
                        <i class="fa-solid fa-chevron-down" style="color: white; font-size: 0.9em;"></i>
                    </div>
                    <div class="custom-select-options hidden" id="country-select-options">
                        <!-- Options will be injected here -->
                    </div>
                </div>
                <input type="hidden" id="country-select" value="">

                <p style="font-size: 0.95em; color: #ff4a4a; margin-top: 15px; font-weight: bold;">Note: This cannot be
                    changed later!</p>
                <p id="country-error" class="error-text hidden">Please select your country.</p>
            </div>

            <button class="btn-buy" id="btn-go-profile" style="margin-top: 20px;">Go to Profile</button>
        </div>
    </div>

    <script>
        const input = document.getElementById('nickname-input');
        const btn = document.getElementById('btn-go-profile');
        const error = document.getElementById('error-msg');
        const countrySelectInput = document.getElementById('country-select');
        const countrySelectWrapper = document.getElementById('country-select-wrapper');
        const countrySelectTrigger = document.getElementById('country-select-trigger');
        const countrySelectDisplay = document.getElementById('country-select-display');
        const countrySelectOptions = document.getElementById('country-select-options');
        const countryError = document.getElementById('country-error');

        const ALL_COUNTRIES = [
            { c: 'AF', n: 'Afghanistan' }, { c: 'AL', n: 'Albania' }, { c: 'DZ', n: 'Algeria' }, { c: 'AR', n: 'Argentina' }, { c: 'AM', n: 'Armenia' },
            { c: 'AU', n: 'Australia' }, { c: 'AT', n: 'Austria' }, { c: 'AZ', n: 'Azerbaijan' }, { c: 'BH', n: 'Bahrain' }, { c: 'BD', n: 'Bangladesh' },
            { c: 'BY', n: 'Belarus' }, { c: 'BE', n: 'Belgium' }, { c: 'BO', n: 'Bolivia' }, { c: 'BA', n: 'Bosnia and Herzegovina' }, { c: 'BR', n: 'Brazil' },
            { c: 'BG', n: 'Bulgaria' }, { c: 'CA', n: 'Canada' }, { c: 'CL', n: 'Chile' }, { c: 'CN', n: 'China' }, { c: 'CO', n: 'Colombia' },
            { c: 'CR', n: 'Costa Rica' }, { c: 'HR', n: 'Croatia' }, { c: 'CU', n: 'Cuba' }, { c: 'CY', n: 'Cyprus' }, { c: 'CZ', n: 'Czech Republic' },
            { c: 'DK', n: 'Denmark' }, { c: 'DO', n: 'Dominican Republic' }, { c: 'EC', n: 'Ecuador' }, { c: 'EG', n: 'Egypt' }, { c: 'SV', n: 'El Salvador' },
            { c: 'EE', n: 'Estonia' }, { c: 'FI', n: 'Finland' }, { c: 'FR', n: 'France' }, { c: 'GE', n: 'Georgia' }, { c: 'DE', n: 'Germany' },
            { c: 'GH', n: 'Ghana' }, { c: 'GR', n: 'Greece' }, { c: 'GT', n: 'Guatemala' }, { c: 'HN', n: 'Honduras' }, { c: 'HK', n: 'Hong Kong' },
            { c: 'HU', n: 'Hungary' }, { c: 'IS', n: 'Iceland' }, { c: 'IN', n: 'India' }, { c: 'ID', n: 'Indonesia' }, { c: 'IR', n: 'Iran' },
            { c: 'IQ', n: 'Iraq' }, { c: 'IE', n: 'Ireland' }, { c: 'IT', n: 'Italy' }, { c: 'JM', n: 'Jamaica' }, { c: 'JP', n: 'Japan' },
            { c: 'JO', n: 'Jordan' }, { c: 'KZ', n: 'Kazakhstan' }, { c: 'KE', n: 'Kenya' }, { c: 'KR', n: 'South Korea' }, { c: 'KW', n: 'Kuwait' },
            { c: 'LV', n: 'Latvia' }, { c: 'LB', n: 'Lebanon' }, { c: 'LY', n: 'Libya' }, { c: 'LT', n: 'Lithuania' }, { c: 'LU', n: 'Luxembourg' },
            { c: 'MY', n: 'Malaysia' }, { c: 'MT', n: 'Malta' }, { c: 'MX', n: 'Mexico' }, { c: 'MA', n: 'Morocco' }, { c: 'NP', n: 'Nepal' },
            { c: 'NL', n: 'Netherlands' }, { c: 'NZ', n: 'New Zealand' }, { c: 'NI', n: 'Nicaragua' }, { c: 'NG', n: 'Nigeria' }, { c: 'NO', n: 'Norway' },
            { c: 'OM', n: 'Oman' }, { c: 'PK', n: 'Pakistan' }, { c: 'PS', n: 'Palestine' }, { c: 'PA', n: 'Panama' }, { c: 'PY', n: 'Paraguay' },
            { c: 'PE', n: 'Peru' }, { c: 'PH', n: 'Philippines' }, { c: 'PL', n: 'Poland' }, { c: 'PT', n: 'Portugal' }, { c: 'PR', n: 'Puerto Rico' },
            { c: 'QA', n: 'Qatar' }, { c: 'RO', n: 'Romania' }, { c: 'RU', n: 'Russia' }, { c: 'SA', n: 'Saudi Arabia' }, { c: 'SN', n: 'Senegal' },
            { c: 'RS', n: 'Serbia' }, { c: 'SG', n: 'Singapore' }, { c: 'SK', n: 'Slovakia' }, { c: 'SI', n: 'Slovenia' }, { c: 'ZA', n: 'South Africa' },
            { c: 'ES', n: 'Spain' }, { c: 'LK', n: 'Sri Lanka' }, { c: 'SD', n: 'Sudan' }, { c: 'SE', n: 'Sweden' }, { c: 'CH', n: 'Switzerland' },
            { c: 'SY', n: 'Syria' }, { c: 'TW', n: 'Taiwan' }, { c: 'TZ', n: 'Tanzania' }, { c: 'TH', n: 'Thailand' }, { c: 'TN', n: 'Tunisia' },
            { c: 'TR', n: 'Turkey' }, { c: 'UA', n: 'Ukraine' }, { c: 'AE', n: 'United Arab Emirates' }, { c: 'GB', n: 'United Kingdom' },
            { c: 'US', n: 'United States' }, { c: 'UY', n: 'Uruguay' }, { c: 'UZ', n: 'Uzbekistan' }, { c: 'VE', n: 'Venezuela' }, { c: 'VN', n: 'Vietnam' },
            { c: 'YE', n: 'Yemen' }
        ];

        // Populate custom dropdown options
        ALL_COUNTRIES.forEach(country => {
            const option = document.createElement('div');
            option.className = 'custom-option';
            option.dataset.value = country.c;
            option.dataset.name = country.n;
            option.innerHTML = `<img src="https://hatscripts.github.io/circle-flags/flags/${country.c.toLowerCase()}.svg" alt="${country.c}"> <span style="font-family: 'Roboto', sans-serif;">${country.n}</span>`;

            option.addEventListener('click', (e) => {
                e.stopPropagation();
                countrySelectInput.value = country.c;
                countrySelectInput.dataset.name = country.n;
                countrySelectDisplay.innerHTML = `<img src="https://hatscripts.github.io/circle-flags/flags/${country.c.toLowerCase()}.svg" alt="${country.c}"> <span style="font-family: 'Roboto', sans-serif;">${country.n}</span>`;
                countrySelectOptions.classList.add('hidden');
            });

            countrySelectOptions.appendChild(option);
        });

        // Toggle dropdown
        countrySelectTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            countrySelectOptions.classList.toggle('hidden');
        });

        // Close when clicked outside
        document.addEventListener('click', (e) => {
            if (!countrySelectWrapper.contains(e.target)) {
                countrySelectOptions.classList.add('hidden');
            }
        });

        // Pre-select detected IP location if available
        let detectedCode = localStorage.getItem('worldClickerCountryCode');
        if (detectedCode === 'IL') detectedCode = 'PS'; // Map internally before defaulting

        if (detectedCode) {
            const detectedCountry = ALL_COUNTRIES.find(c => c.c === detectedCode);
            if (detectedCountry) {
                countrySelectInput.value = detectedCountry.c;
                countrySelectInput.dataset.name = detectedCountry.n;
                countrySelectDisplay.innerHTML = `<img src="https://hatscripts.github.io/circle-flags/flags/${detectedCountry.c.toLowerCase()}.svg" alt="${detectedCountry.c}"> <span style="font-family: 'Roboto', sans-serif;">${detectedCountry.n}</span>`;
            }
        }

        function validateNickname(name) {
            if (!name) return false;
            if (name.length < 3 || name.length > 12) return false;
            // Regex: only letters, numbers, dots, underscores, hyphens. No spaces.
            const regex = /^[a-zA-Z0-9._-]+$/;
            return regex.test(name);
        }

        function saveAndRedirect() {
            const val = input.value.trim();
            const selectedCountryCode = countrySelectInput.value;
            const selectedCountryName = countrySelectInput.dataset.name || '';

            let isValid = true;

            countryError.classList.add('hidden');
            error.classList.add('hidden');

            if (!validateNickname(val)) {
                error.textContent = "Nickname must be 3-12 valid English/Latin characters.";
                error.classList.remove('hidden');
                isValid = false;
            }

            if (!selectedCountryCode) {
                countryError.textContent = "Please confirm your country from the list.";
                countryError.classList.remove('hidden');
                isValid = false;
            }

            if (!isValid) return;

            // Save authoritative country to localStorage unconditionally
            localStorage.setItem('worldClickerCountryCode', selectedCountryCode);
            localStorage.setItem('worldClickerCountryName', selectedCountryName);

            apiPost('/auth/set-nickname', {
                nickname: val,
                country_code: selectedCountryCode,
                country_name: selectedCountryName
            }).then(result => {
                if (result && result.success) {
                    setToken(result.token);
                    setPlayerNickname(result.nickname);

                    const params = new URLSearchParams(window.location.search);
                    const score = params.get('score') || '0';
                    window.location.href = `profile.html?name=${encodeURIComponent(result.nickname)}&score=${score}`;
                } else {
                    error.textContent = result?.error || 'Could not save nickname. It might be taken.';
                    error.classList.remove('hidden');
                }
            }).catch(e => {
                error.textContent = 'Server error. Please try again.';
                error.classList.remove('hidden');
            });
        }

        btn.addEventListener('click', saveAndRedirect);

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveAndRedirect();
            }
        });

        input.addEventListener('input', () => {
            error.classList.add('hidden');
            // Real-time restriction: Allow only a-z, A-Z, 0-9, ., _, -
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const originalValue = input.value;
            const cleanValue = originalValue.replace(/[^a-zA-Z0-9._-]/g, '');

            if (originalValue !== cleanValue) {
                input.value = cleanValue;
                // Try to maintain cursor position
                input.setSelectionRange(start, end);
            }
        });

        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
    <div id="custom-cursor"></div>
    <script>
        (function () {
            if (window.matchMedia("(pointer: coarse)").matches) return;
            const cursor = document.getElementById('custom-cursor');
            if (!cursor) return;
            document.addEventListener('mousemove', (e) => {
                cursor.style.left = e.clientX + 'px';
                cursor.style.top = e.clientY + 'px';
                const isClickable = e.target.closest('i, button, a, .menu-item, .tab-btn, .mobile-menu-item, .back-link') ||
                    window.getComputedStyle(e.target).cursor === 'pointer';
                cursor.style.transform = isClickable ? "scale(1.1) translateZ(9999px)" : "none translateZ(9999px)";
            });
            document.addEventListener('mouseleave', () => cursor.style.display = 'none');
            document.addEventListener('mouseenter', () => cursor.style.display = 'block');
        })();
    </script>
</body>

</html>